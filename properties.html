<!--
 * Copyright 2023 Justin Parra. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 -->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.amber-pink.min.css" />
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <style>
      body {
        margin: 0;
        display: flex;
        justify-content: center;
      }

      .container {
        height: 100vh;
        width: 100vw;
        max-width: 1060px;
      }

      .card-wide {
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="mdl-grid">
        <div class="mdl-cell mdl-cell--2-col mdl-cell--1-col-tablet mdl-cell--hide-phone"></div>
        <div class="mdl-cell mdl-cell--8-col mdl-cell--10-col-tablet mdl-cell--12-col-phone">
          <div class="card-wide mdl-card mdl-shadow--2dp">
            <div class="mdl-card__title">
              <h2 class="mdl-card__title-text">User Property Editor</h2>
            </div>
            <form onsubmit="handleFormSubmit(this)">
              <div class="mdl-card__supporting-text">
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input
                    class="mdl-textfield__input"
                    type="text"
                    id="prefix"
                    name="prefix"
                    value="<?= PropertiesForm.GetPrefix() ?>"
                  />
                  <label class="mdl-textfield__label" for="prefix">Habitica Todo Prefix</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input
                    class="mdl-textfield__input"
                    type="text"
                    id="key"
                    name="key"
                    value="<?= PropertiesForm.GetKey() ?>"
                  />
                  <label class="mdl-textfield__label" for="key">Habitica API Key</label>
                </div>
                <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                  <input
                    class="mdl-textfield__input"
                    type="text"
                    id="user"
                    name="user"
                    value="<?= PropertiesForm.GetUser() ?>"
                  />
                  <label class="mdl-textfield__label" for="user">Habitica API User</label>
                </div>
              </div>
              <div class="mdl-card__actions mdl-card--border">
                <button
                  type="submit"
                  value="Submit"
                  class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect"
                >
                  Save Habitica Props
                </button>
                <!-- prettier-ignore -->
                <button
                  id="returnBtn"
                  type="button"
                  onclick="navigateHome()"
                  class="mdl-button mdl-button--accent mdl-js-button mdl-js-ripple-effect"
                  <? if (!PropertiesForm.HasValidProperites()) { ?>
                  disabled
                  <? } ?>
                  > Return to tasks
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="mdl-cell mdl-cell--2-col mdl-cell--1-col-tablet mdl-cell--hide-phone"></div>
      </div>
      <div id="toast" class="mdl-js-snackbar mdl-snackbar">
        <div class="mdl-snackbar__text"></div>
        <button class="mdl-snackbar__action" type="button"></button>
      </div>
    </div>
    <!-- Store data passed to template here, so it is available to the
  imported JavaScript. -->
    <script>
      // Prevent forms from submitting.
      function preventFormSubmit() {
        var forms = document.querySelectorAll("form");
        for (var i = 0; i < forms.length; i++) {
          forms[i].addEventListener("submit", function (event) {
            event.preventDefault();
          });
        }
      }
      window.addEventListener("load", preventFormSubmit);

      function processSuccess(success) {
        const hadValidProperites = "<?= PropertiesForm.HasValidProperites() ?>" === "true";
        const snackbarContainer = document.querySelector("#toast");
        const data = { message: "was successful" };
        if (!hadValidProperites) {
          data["timeout"] = 100000;
          data["actionText"] = "Goto Tasks";
          data["actionHandler"] = () => {
            navigateHome();
          };
        }
        document.querySelector("#returnBtn").disabled = false;
        snackbarContainer.MaterialSnackbar.showSnackbar(data);
      }
      /* Handle the form submit but sending request to app script backend. */
      function handleFormSubmit(formObject) {
        google.script.run.withSuccessHandler(processSuccess).ProcessPropertiesForm(formObject);
      }
      function navigateHome() {
        window.top.location.href = "<?= PropertiesForm.GetScriptUrl() ?>";
      }
    </script>
  </body>
</html>
