<!--
 * Copyright 2023 Justin Parra. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 -->

<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.css"
    />
    <!-- Required Material Web JavaScript library -->
    <script src="https://unpkg.com/material-components-web@latest/dist/material-components-web.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <style>
      :root {
        --mdc-theme-primary: #344955;
        --mdc-theme-secondary: #f9aa33;
        font-size: large;

        .mdc-drawer .mdc-deprecated-list-item--activated {
          color: var(--mdc-theme-secondary);
        }

        .mdc-drawer .mdc-deprecated-list-item--activated .mdc-deprecated-list-item__graphic {
          color: var(--mdc-theme-secondary);
        }
      }

      html {
        overflow-x: hidden;
      }

      body {
        margin: 0;
        width: 100vw;
        height: 100vh;
      }

      .mdl-layout__content {
        display: flex;
        justify-content: center;
      }

      .container {
        height: 100vh;
        width: 100vw;
        max-width: 1200px;
      }

      .card-wide {
        width: 100%;
      }

      .child-row {
        display: flex;
        flex-direction: row;
      }

      .child-col {
        display: flex;
        flex-direction: column;
        flex: auto;
      }

      .child-decoration {
        border-left: 2px solid black;
        padding-left: 16px;
      }

      .spacer {
        flex: auto;
      }

      .node-text {
        padding-top: 5px;
        padding-left: 5px;
        border-radius: var(--mdc-text-button-container-shape, var(--mdc-shape-small, 4px));
      }

      .quick-wrapper {
        position: fixed;
        right: 32px;
        bottom: 32px;
        display: flex;
        flex-direction: row;
        align-items: center;
      }

      .animate {
        -webkit-transition: all 300ms 50ms cubic-bezier(0.4, 0, 1, 1);
        -moz-transition: all 300ms 50ms cubic-bezier(0.4, 0, 1, 1);
        -o-transition: all 300ms 50ms cubic-bezier(0.4, 0, 1, 1);
        transition: all 300ms 50ms cubic-bezier(0.4, 0, 1, 1);
      }
    </style>
  </head>
  <body>
    <header class="mdc-top-app-bar mdc-top-app-bar--fixed">
      <div class="mdc-top-app-bar__row">
        <section class="mdc-top-app-bar__section mdc-top-app-bar__section--align-start">
          <button
            class="material-icons mdc-top-app-bar__navigation-icon mdc-icon-button"
            onclick="handleMenuClick()"
          >
            menu
          </button>
          <span class="mdc-top-app-bar__title">Habitica Tasks</span>
        </section>
        <section
          class="mdc-top-app-bar__section mdc-top-app-bar__section--align-end"
          role="toolbar"
        >
          <div class="mdc-menu-surface--anchor">
            <button
              class="material-icons mdc-top-app-bar__action-item mdc-icon-button"
              aria-label="Add task/group"
              onclick="handleAddBtnClick()"
            >
              add
            </button>
            <div class="mdc-menu mdc-menu-surface">
              <ul
                class="mdc-deprecated-list"
                role="menu"
                aria-hidden="true"
                aria-orientation="vertical"
                tabindex="-1"
              >
                <li class="mdc-deprecated-list-item" role="menuitem">
                  <span class="mdc-deprecated-list-item__ripple"></span>
                  <span class="mdc-deprecated-list-item__text">Add New Group</span>
                </li>
                <li class="mdc-deprecated-list-item" role="menuitem">
                  <span class="mdc-deprecated-list-item__ripple"></span>
                  <span class="mdc-deprecated-list-item__text">Add New Task</span>
                </li>
              </ul>
            </div>
          </div>
        </section>
      </div>

      <div
        role="progressbar"
        class="mdc-linear-progress"
        aria-label="progress bar"
        aria-valuemin="0"
        aria-valuemax="1"
        aria-valuenow="0"
      >
        <div class="mdc-linear-progress__buffer">
          <div class="mdc-linear-progress__buffer-bar"></div>
          <div class="mdc-linear-progress__buffer-dots"></div>
        </div>
        <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
          <span class="mdc-linear-progress__bar-inner"></span>
        </div>
        <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
          <span class="mdc-linear-progress__bar-inner"></span>
        </div>
      </div>
    </header>

    <aside class="mdc-drawer mdc-drawer--modal">
      <div class="mdc-drawer__content">
        <nav class="mdc-deprecated-list">
          <a
            class="mdc-deprecated-list-item mdc-deprecated-list-item--activated"
            href="#"
            aria-current="page"
            tabindex="0"
          >
            <span class="mdc-deprecated-list-item__ripple"></span>
            <i class="material-icons mdc-deprecated-list-item__graphic" aria-hidden="true">inbox</i>
            <span class="mdc-deprecated-list-item__text">Inbox</span>
          </a>
          <a class="mdc-deprecated-list-item" href="#">
            <span class="mdc-deprecated-list-item__ripple"></span>
            <i class="material-icons mdc-deprecated-list-item__graphic" aria-hidden="true">send</i>
            <span class="mdc-deprecated-list-item__text">Outgoing</span>
          </a>
          <a class="mdc-deprecated-list-item" href="#">
            <span class="mdc-deprecated-list-item__ripple"></span>
            <i class="material-icons mdc-deprecated-list-item__graphic" aria-hidden="true"
              >drafts</i
            >
            <span class="mdc-deprecated-list-item__text">Drafts</span>
          </a>
        </nav>
      </div>
    </aside>
    <div class="mdc-drawer-scrim"></div>

    <main class="mdc-top-app-bar--fixed-adjust">
      <div class="mdc-layout-grid">
        <div class="mdc-layout-grid__inner">
          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2-desktop"></div>
          <div
            class="mdc-layout-grid__cell mdc-layout-grid__cell--span-8-desktop mdc-layout-grid__cell--span-8-tablet mdc-layout-grid__cell--span-4-phone mdc-layout-grid__cell--align-middle"
          >
            <div class="mdc-layout-grid__inner">
              <? const roots = TasksHtml.GetRoots();
               for (const root of roots) { ?>
              <div
                class="mdc-layout-grid__cell mdc-layout-grid__cell--span-6-desktop mdc-layout-grid__cell--span-8-tablet mdc-layout-grid__cell--span-4-phone mdc-layout-grid__cell--align-middle"
              >
                <div class="mdc-card">
                  <div class="mdc-card__primary-action" tabindex="0">
                    <div class="editor-card__secondary mdc-typography mdc-typography--body2">
                      <div class="mdc-layout-grid">
                        <div class="mdc-layout-grid__inner">
                          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-12">
                            <!-- Text container segment -->
                            <div class="child-col mdc-ripple-surface node-text">
                              <div class="child-row">
                                <div class="mdc-touch-target-wrapper">
                                  <div class="mdc-checkbox mdc-checkbox--touch">
                                    <!-- prettier-ignore -->
                                    <input
                                      type="checkbox"
                                      class="mdc-checkbox__native-control"
                                      id="checkbox-1"
                                      name="<?= TasksHtml.GetId(root) ?>"
                                      onclick="handleCheckboxClick('<?= TasksHtml.GetId(root) ?>', this)"
                                      <? if (TasksHtml.IsTaskCompleted(root)) { ?>
                                    checked
                                    <? } ?>
                                    />
                                    <div class="mdc-checkbox__background">
                                      <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                        <path
                                          class="mdc-checkbox__checkmark-path"
                                          fill="none"
                                          d="M1.73,12.91 8.1,19.28 22.79,4.59"
                                        />
                                      </svg>
                                      <div class="mdc-checkbox__mixedmark"></div>
                                    </div>
                                    <div class="mdc-checkbox__ripple"></div>
                                    <div class="mdc-checkbox__focus-ring"></div>
                                  </div>
                                </div>
                                <div class="mdc-touch-target-wrapper">
                                  <button
                                    class="mdc-icon-button"
                                    onclick="handleEditClick('<?= TasksHtml.IsGroup(root) ?>', '<?= TasksHtml.GetId(root) ?>', this)"
                                  >
                                    <div class="mdc-icon-button__ripple"></div>
                                    <span class="mdc-icon-button__focus-ring"></span>
                                    <i class="material-icons">edit</i>
                                  </button>
                                </div>
                                <div class="child-col">
                                  <span class="mdc-typography--body1"
                                    ><?= TasksHtml.GetText(root) ?></span
                                  >
                                </div>
                              </div>
                            </div>

                            <!-- Root segment children -->
                            <? if (TasksHtml.HasChildren(root)) { ?>
                            <div class="child-row">
                              <div class="child-decoration"></div>
                              <div class="child-col">
                                <? const firstChildren = TasksHtml.GetChildren(root);
                                 for (const firstChild of firstChildren) { ?>
                                <!-- Text container segment -->
                                <div class="child-col mdc-ripple-surface node-text">
                                  <div class="child-row">
                                    <div class="mdc-touch-target-wrapper">
                                      <div class="mdc-checkbox mdc-checkbox--touch">
                                        <!-- prettier-ignore -->
                                        <input
                                          type="checkbox"
                                          class="mdc-checkbox__native-control"
                                          id="checkbox-1"
                                          name="<?= TasksHtml.GetId(firstChild) ?>"
                                          onclick="handleCheckboxClick('<?= TasksHtml.GetId(firstChild) ?>', this)"
                                          <? if (TasksHtml.IsTaskCompleted(firstChild)) { ?>
                                        checked
                                        <? } ?>
                                        />
                                        <div class="mdc-checkbox__background">
                                          <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                            <path
                                              class="mdc-checkbox__checkmark-path"
                                              fill="none"
                                              d="M1.73,12.91 8.1,19.28 22.79,4.59"
                                            />
                                          </svg>
                                          <div class="mdc-checkbox__mixedmark"></div>
                                        </div>
                                        <div class="mdc-checkbox__ripple"></div>
                                        <div class="mdc-checkbox__focus-ring"></div>
                                      </div>
                                    </div>
                                    <div class="mdc-touch-target-wrapper">
                                      <button
                                        class="mdc-icon-button"
                                        onclick="handleEditClick('<?= TasksHtml.IsGroup(firstChild) ?>', '<?= TasksHtml.GetId(firstChild) ?>', this)"
                                      >
                                        <div class="mdc-icon-button__ripple"></div>
                                        <span class="mdc-icon-button__focus-ring"></span>
                                        <i class="material-icons">edit</i>
                                      </button>
                                    </div>
                                    <div class="child-col">
                                      <span class="mdc-typography--body1"
                                        ><?= TasksHtml.GetText(firstChild) ?></span
                                      >
                                    </div>
                                  </div>
                                </div>

                                <!-- First layer children -->
                                <? if (TasksHtml.HasChildren(firstChild)) { ?>
                                <div class="child-row">
                                  <div class="child-decoration"></div>
                                  <div class="child-col">
                                    <? const secondChildren = TasksHtml.GetChildren(firstChild);
                                       for (const secondChild of secondChildren) { ?>
                                    <!-- Text container segment -->
                                    <div class="child-col mdc-ripple-surface node-text">
                                      <div class="child-row">
                                        <div class="mdc-touch-target-wrapper">
                                          <div class="mdc-checkbox mdc-checkbox--touch">
                                            <!-- prettier-ignore -->
                                            <input
                                          type="checkbox"
                                          class="mdc-checkbox__native-control"
                                          id="checkbox-1"
                                          name="<?= TasksHtml.GetId(secondChild) ?>"
                                          onclick="handleCheckboxClick('<?= TasksHtml.GetId(secondChild) ?>', this)"
                                          <? if (TasksHtml.IsTaskCompleted(secondChild)) { ?>
                                            checked
                                            <? } ?>
                                            />
                                            <div class="mdc-checkbox__background">
                                              <svg
                                                class="mdc-checkbox__checkmark"
                                                viewBox="0 0 24 24"
                                              >
                                                <path
                                                  class="mdc-checkbox__checkmark-path"
                                                  fill="none"
                                                  d="M1.73,12.91 8.1,19.28 22.79,4.59"
                                                />
                                              </svg>
                                              <div class="mdc-checkbox__mixedmark"></div>
                                            </div>
                                            <div class="mdc-checkbox__ripple"></div>
                                            <div class="mdc-checkbox__focus-ring"></div>
                                          </div>
                                        </div>
                                        <div class="mdc-touch-target-wrapper">
                                          <button
                                            class="mdc-icon-button"
                                            onclick="handleEditClick('<?= TasksHtml.IsGroup(secondChild) ?>', '<?= TasksHtml.GetId(secondChild) ?>', this)"
                                          >
                                            <div class="mdc-icon-button__ripple"></div>
                                            <span class="mdc-icon-button__focus-ring"></span>
                                            <i class="material-icons">edit</i>
                                          </button>
                                        </div>
                                        <div class="child-col">
                                          <span class="mdc-typography--body1"
                                            ><?= TasksHtml.GetText(secondChild) ?></span
                                          >
                                        </div>
                                      </div>
                                    </div>
                                    <? } ?>
                                  </div>
                                </div>
                                <? } ?>
                                <? } ?>
                              </div>
                            </div>
                            <? } ?>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <? } ?>
            </div>
          </div>
          <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2-desktop"></div>
        </div>
      </div>
    </main>

    <!-- Shortcut to add tasks -->
    <div class="mdc-touch-target-wrapper quick-wrapper">
      <div
        class="mdc-circular-progress"
        style="width: 48px; height: 48px"
        role="progressbar"
        aria-label="Example Progress Bar"
        aria-valuemin="0"
        aria-valuemax="1"
      >
        <div class="mdc-circular-progress__determinate-container">
          <svg
            class="mdc-circular-progress__determinate-circle-graphic"
            viewBox="0 0 48 48"
            xmlns="http://www.w3.org/2000/svg"
          >
            <circle
              class="mdc-circular-progress__determinate-track"
              cx="24"
              cy="24"
              r="18"
              stroke-width="4"
            />
            <circle
              class="mdc-circular-progress__determinate-circle"
              cx="24"
              cy="24"
              r="18"
              stroke-dasharray="113.097"
              stroke-dashoffset="113.097"
              stroke-width="4"
            />
          </svg>
        </div>
        <div class="mdc-circular-progress__indeterminate-container">
          <div class="mdc-circular-progress__spinner-layer">
            <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-left">
              <svg
                class="mdc-circular-progress__indeterminate-circle-graphic"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle
                  cx="24"
                  cy="24"
                  r="18"
                  stroke-dasharray="113.097"
                  stroke-dashoffset="56.549"
                  stroke-width="4"
                />
              </svg>
            </div>
            <div class="mdc-circular-progress__gap-patch">
              <svg
                class="mdc-circular-progress__indeterminate-circle-graphic"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle
                  cx="24"
                  cy="24"
                  r="18"
                  stroke-dasharray="113.097"
                  stroke-dashoffset="56.549"
                  stroke-width="3.2"
                />
              </svg>
            </div>
            <div class="mdc-circular-progress__circle-clipper mdc-circular-progress__circle-right">
              <svg
                class="mdc-circular-progress__indeterminate-circle-graphic"
                viewBox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <circle
                  cx="24"
                  cy="24"
                  r="18"
                  stroke-dasharray="113.097"
                  stroke-dashoffset="56.549"
                  stroke-width="4"
                />
              </svg>
            </div>
          </div>
        </div>
      </div>
      <button class="mdc-fab mdc-fab--touch animate" onclick="handleQuickShortcut(this)">
        <div class="mdc-fab__ripple"></div>
        <div class="mdc-fab__focus-ring"></div>
        <span class="material-icons mdc-fab__icon">add</span>
        <div
          class="mdc-text-field mdc-text-field--fullwidth mdc-text-field--no-label"
          style="display: none; text-transform: none"
        >
          <input
            type="text"
            id="text-field-fullwidth-helper"
            placeholder="New task text"
            class="mdc-text-field__input"
            aria-label="Quick create task new text"
          />
        </div>
      </button>
    </div>

    <!-- Snackbar -->
    <aside class="mdc-snackbar">
      <div class="mdc-snackbar__surface" role="status" aria-relevant="additions">
        <div class="mdc-snackbar__label" aria-atomic="false">
          Can't send photo. Retry in 5 seconds.
        </div>
      </div>
    </aside>
    <!-- Store data passed to template here, so it is available to the imported JavaScript. -->
    <script>
      var ripples;
      var drawer;
      var addMenu;
      var linearProgress;
      var checkboxes = [];
      var quickTask;
      var quickTaskProgress;
      var snackbar;
      window.addEventListener("load", () => {
        // Create ripples.
        const selector = ".mdc-button, .mdc-icon-button, .mdc-card__primary-action, .mdc-fab";
        ripples = [].map.call(document.querySelectorAll(selector), (el) => {
          return mdc.ripple.MDCRipple.attachTo(el);
        });

        // Create top bar.
        const topAppBarElement = document.querySelector(".mdc-top-app-bar");
        mdc.topAppBar.MDCTopAppBar.attachTo(topAppBarElement);

        // Create drawer.
        drawer = mdc.drawer.MDCDrawer.attachTo(document.querySelector(".mdc-drawer"));

        // Create add menu.
        addMenu = mdc.menu.MDCMenu.attachTo(document.querySelector(".mdc-menu"));
        addMenu.foundation.adapter.notifySelected = (t) => {
          if (t.index === 0) {
            window.top.location.href = "<?= Utils.GetScriptUrl('?path=addGroup') ?>";
          } else if (t.index === 1) {
            window.top.location.href = "<?= Utils.GetScriptUrl('?path=addItem') ?>";
          }
        };

        document.querySelectorAll(".mdc-checkbox").forEach((el) => {
          const checkbox = mdc.checkbox.MDCCheckbox.attachTo(el);
          checkbox.handleChange = (f) => {
            console.log("handleChange", f, checkbox);
          };
          checkboxes.push(checkbox);
        });

        linearProgress = mdc.linearProgress.MDCLinearProgress.attachTo(
          document.querySelector(".mdc-linear-progress")
        );
        linearProgress.foundation.setDeterminate(false);
        linearProgress.foundation.close();

        quickTask = mdc.textField.MDCTextField.attachTo(document.querySelector(".mdc-text-field"));
        quickTask.foundation.adapter.registerInputInteractionHandler("focusout", (e) => {
          quickTask.root.parentElement.classList.remove("mdc-fab--extended");
          quickTask.root.style.display = "none";
        });
        quickTask.foundation.adapter.registerInputInteractionHandler("keypress", (e) => {
          console.log("keypress", e);
          if (e.key === "Enter") {
            quickTask.disabled = true;
            quickTaskProgress.foundation.open();
            google.script.run
              .withSuccessHandler((resp) => {
                quickTask.disabled = false;
                quickTaskProgress.foundation.close();
                if (!resp.ok) {
                  snackbar.open();
                  document.querySelector(
                    ".mdc-snackbar__label"
                  ).innerText = `Error "${resp.error}"`;

                  quickTask.foundation.activateFocus();
                } else {
                  snackbar.open();
                  document.querySelector(".mdc-snackbar__label").innerText =
                    "Successfully added task.";

                  quickTask.root.parentElement.classList.remove("mdc-fab--extended");
                  quickTask.root.style.display = "none";
                }
              })
              .withFailureHandler(() => {
                snackbar.open();
                document.querySelector(
                  ".mdc-snackbar__label"
                ).innerText = `Unknown error when attempting to add task.`;
                quickTask.disabled = false;
                quickTask.foundation.activateFocus();
                quickTaskProgress.foundation.close();
              })
              .AttemptQuickCreateTask(quickTask.value);
          }
        });

        quickTaskProgress = mdc.circularProgress.MDCCircularProgress.attachTo(
          document.querySelector(".mdc-circular-progress")
        );
        quickTaskProgress.foundation.setDeterminate(false);
        quickTaskProgress.foundation.close();

        snackbar = mdc.snackbar.MDCSnackbar.attachTo(document.querySelector(".mdc-snackbar"));
      });

      function handleMenuClick() {
        drawer.open = true;
      }
      function handleAddBtnClick() {
        addMenu.open = true;
      }
      function handleCheckboxClick(id, element) {
        linearProgress.foundation.open();
        element.disabled = true;
        google.script.run
          .withSuccessHandler((resp) => {
            element.disabled = false;
            linearProgress.foundation.close();
            if (!resp.ok) {
              element.checked = !element.checked;
              snackbar.open();
              document.querySelector(".mdc-snackbar__label").innerText = `Error "${resp.error}"`;
            } else {
              snackbar.open();
              document.querySelector(
                ".mdc-snackbar__label"
              ).innerText = `Successfully updated complete state.`;
            }
          })
          .withFailureHandler(() => {
            snackbar.open();
            document.querySelector(
              ".mdc-snackbar__label"
            ).innerText = `Unknown error when attempting to modify complete state.`;
            element.disabled = false;
            element.checked = !element.checked;
            linearProgress.foundation.close();
          })
          .AttemptChangeTaskComplete(id, element.checked);
      }
      function handleQuickShortcut(element) {
        element.classList.add("mdc-fab--extended");
        element.querySelector(".mdc-text-field").style.display = "";
        queueMicrotask(() => {
          element.querySelector("input").focus();
        });
      }
      function handleEditClick(isGroup, id, element) {
        linearProgress.open();
        element.disabled = true;
        if (isGroup === "true") {
          const baseUrl = "<?= Utils.GetScriptUrl('?path=addGroup') ?>";
          window.top.location.href = `${baseUrl}&selectedGroup=${id}`;
        }
      }
    </script>
  </body>
</html>
